sudo mkdir -p /mnt/disks/sec
sudo chmod 777 /mnt/disks/sec

git clone --single-branch --branch master https://github.com/r3fang/merfishdecoder

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/miniconda
echo ". $HOME/miniconda/etc/profile.d/conda.sh" >> ~/.bashrc
echo "conda activate" >> ~/.bashrc
echo "export GOOGLE_APPLICATION_CREDENTIALS=$HOME/merfishdecoder/gcloud-keys/MerifshDecoder-c5312aaac037.json" >> ~/.bashrc
source .bashrc
conda activate base
conda config --set always_yes true
conda config --set quiet true
conda create -n md_env python=3.6
source activate md_env
conda install rtree pytables
conda install -c conda-forge sharedarray
pip install -e merfishdecoder
printf 'DATA_HOME=gc://r3fang/MERFISH_raw_data/\nANALYSIS_HOME=/mnt/disks/sec\nPARAMETERS_HOME=~/merfishdecoder/merfish-parameters/' >~/.md_env

#merfishdecoder create-analysis \
#	--data-set-name=191010_LMN7_DIV18_Map2Tau \
#	--codebook-name=hMTGE1_V11_codebook_4000.csv \
#	--data-organization-name=hMTGdataorganization_48bit_6z.v11.csv \
#	--microscope-parameter-name=MERFISH_MZ.json \
#	--microscope-chromatic-aberration-name=MERFIFH_MZ_ca_profile_2020_10_01_.pkl \
#	--position-name=20200303_hMTG_V11_4000gene_best_sample_positions.csv 



ANALYSIS_DIR="/mnt/NAS/Fang/Analysis/MERFISH/merfish_analysis/191010_LMN7_DIV18_Map2Tau"
FOV=188

for ZPOS in 0.0  1.0  2.0  3.0  4.0  5.0  6.0  7.0  8.0  9.0 10.0 11.0
do
	merfishdecoder register-images \
		--data-set-name=191010_LMN7_DIV18_Map2Tau \
		--fov=$FOV \
		--zpos=$ZPOS \
		--output-name=$ANALYSIS_DIR/warpedImages/fov_$FOV\_zpos_$ZPOS.tif \
		--register-drift=True \
		--ref-frame-index=0 \
		--high-pass-filter-sigma=3 \
		--register-color=False \
		--save-fiducials=True
	merfishdecoder process-images \
		--data-set-name=191010_LMN7_DIV18_Map2Tau \
		--fov=$FOV  \
		--zpos=$ZPOS \
		--warped-images-name=$ANALYSIS_DIR/warpedImages/fov_$FOV\_zpos_$ZPOS.tif \
		--output-name=$ANALYSIS_DIR/processedImages/fov_$FOV\_zpos_$ZPOS.npz \
		--log-transform=False
	merfishdecoder predict-prob \
		--data-set-name=191010_LMN7_DIV18_Map2Tau \
		--fov=$FOV  \
		--zpos=$ZPOS \
		--processed-images-name=$ANALYSIS_DIR/processedImages/fov_$FOV\_zpos_$ZPOS.npz \
		--model-name=gmModelParam.v2.pkl \
		--output-name=$ANALYSIS_DIR/probImages/fov_$FOV\_zpos_$ZPOS.npz \
		--kernel-size=3
done

merfishdecoder decode-images \
	--data-set-name=191010_LMN7_DIV18_Map2Tau \
	--fov=$FOV \
	--zpos=$ZPOS \
	--decoding-images-name=$ANALYSIS_DIR/processedImages/fov_$FOV\_zpos_$ZPOS.npz \
	--output-name=$ANALYSIS_DIR/decodedImages/fov_$FOV\_zpos_$ZPOS.npz \
	--border-size=80 \
	--distance-threshold=0.65 \
	--magnitude-threshold=1 \
	--max-cores=10

merfishdecoder extract-barcodes \
	--data-set-name=191010_LMN7_DIV18_Map2Tau \
	--fov=$FOV \
	--zpos=$ZPOS \
	--decoded-images-name=$ANALYSIS_DIR/decodedImages/fov_$FOV\_zpos_$ZPOS.npz \
	--output-name=decodedBarcodes/fov_$FOV\_zpos_$ZPOS.h5 \
	--barcodes-per-core=10 \
	--max-cores=10

merfishdecoder extract-pixel-traces \
	--data-set-name=191010_LMN7_DIV18_Map2Tau \
	--fov=$FOV \
	--zpos=$ZPOS \
	--extracted-barcodes-name=$ANALYSIS_DIR/extractedBarcodes/fov_$FOV\_zpos_$ZPOS.h5 \
	--processed-images-name=$ANALYSIS_DIR/processedImages/fov_$FOV\_zpos_$ZPOS.npz \
	--decoded-images-name=$ANALYSIS_DIR/decodedImages/fov_$FOV\_zpos_$ZPOS.npz \
	--output-name=$ANALYSIS_DIR/extractedPixelTraces/fov_$FOV\_zpos_$ZPOS.h5 \
	--area-size-threshold=5 \
	--distance-threshold=0.65 \
	--magnitude-threshold=1
















for ZPOS in 1.0 2.0 3.0 4.0 5.0 6.0; do
done

for ZPOS in 1.0 2.0 3.0 4.0 5.0 6.0; do
	merfishdecoder decode-images \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--decoding-images-name=$ANALYSIS_DIR/processedImages/fov_$FOV\_zpos_$ZPOS.npz \
		--output-name=$ANALYSIS_DIR/decodedImages/fov_$FOV\_zpos_$ZPOS.npz \
		--border-size=80 \
		--distance-threshold=0.65 \
		--max-cores=10
done

merfishdecoder train-psm \
	--data-set-name=MERFISH_test/data \
	--decoded-images-name $ANALYSIS_DIR/decodedImages/* \
	--output-name=pixel_score_machine.pkl \
	--zpos-num=50

for ZPOS in 1.0 2.0 3.0 4.0 5.0 6.0; do
	merfishdecoder extract-barcodes \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--decoded-images-name=$ANALYSIS_DIR/decodedImages/fov_$FOV\_zpos_$ZPOS.npz \
		--psm-name=pixel_score_machine.pkl \
		--output-name=decodedBarcodes/fov_$FOV\_zpos_$ZPOS.h5
done

merfishdecoder export-barcodes \
	--data-set-name=MERFISH_test/data \
	--decoded-barcodes-dir=decodedBarcodes \
	--output-name=$ANALYSIS_DIR/exportedBarcodes/barcodes.h5 \
	--zpos-num=100 \
	--mis-identification-rate=0.05 \
	--min-area=3 \
	--max-area=100

for ZPOS in 1.0 2.0 3.0 4.0 5.0 6.0;
do
	merfishdecoder segmentation \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--warped-images-name=$ANALYSIS_DIR/warpedImages/fov_$FOV\_zpos_$ZPOS.tif \
		--output-name=$ANALYSIS_DIR/segmentedImages/fov_$FOV\_zpos_$ZPOS\_DAPI.npz \
		--feature-name=DAPI 
	merfishdecoder segmentation \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--warped-images-name=$ANALYSIS_DIR/warpedImages/fov_$FOV\_zpos_$ZPOS.tif \
		--output-name=$ANALYSIS_DIR/segmentedImages/fov_$FOV\_zpos_$ZPOS\_polyT.npz \
		--feature-name=polyT 
done

for ZPOS in 1.0 2.0 3.0 4.0 5.0 6.0; do
	merfishdecoder extract-features \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--segmented-images-name=$ANALYSIS_DIR/segmentedImages/fov_$FOV\_zpos_$ZPOS\_DAPI.npz \
		--output-name=$ANALYSIS_DIR/segmentedFeatures/fov_$FOV\_zpos_$ZPOS\_DAPI
	merfishdecoder extract-features \
		--data-set-name=MERFISH_test/data \
		--fov=$FOV \
		--zpos=$ZPOS \
		--segmented-images-name=$ANALYSIS_DIR/segmentedImages/fov_$FOV\_zpos_$ZPOS\_polyT.npz \
		--output-name=$ANALYSIS_DIR/segmentedFeatures/fov_$FOV\_zpos_$ZPOS\_polyT
done

merfishdecoder export-features \
	--data-set-name=MERFISH_test/data \
	--segmented-features-name $ANALYSIS_DIR/segmentedFeatures/fov_*_DAPI \
	--output-name=exportedFeatures/DAPI \
	--min-zplane=3 \
	--border-size=80

merfishdecoder export-features \
	--data-set-name=MERFISH_test/data \
	--segmented-features-name $ANALYSIS_DIR/segmentedFeatures/fov_*_polyT \
	--output-name=exportedFeatures/polyT \
	--min-zplane=3 \
	--border-size=80













